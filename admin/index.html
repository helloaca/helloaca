<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Helloaca Admin</title>
  <link rel="icon" href="https://helloaca.xyz/favicon.ico">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg:#0f172a; --panel:#111827; --accent:#4f46e5; --text:#e5e7eb; --muted:#9ca3af; --red:#ef4444; --green:#22c55e; }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
    a { color: var(--accent); text-decoration: none; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .panel { background: var(--panel); border: 1px solid #1f2937; border-radius: 12px; padding: 20px; }
    .grid { display: grid; gap: 20px; }
    .grid-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .grid-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .grid-responsive { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
    .row { display: flex; gap: 12px; align-items: center; }
    .row-wrap { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .input { width: 100%; padding: 10px 12px; border: 1px solid #374151; border-radius: 8px; background: #0b1220; color: var(--text); outline: none; }
    .select { width: 100%; padding: 10px 12px; border: 1px solid #374151; border-radius: 8px; background: #0b1220; color: var(--text); outline: none; }
    .textarea { width: 100%; min-height: 120px; padding: 10px 12px; border: 1px solid #374151; border-radius: 8px; background: #0b1220; color: var(--text); outline: none; }
    .btn { padding: 10px 14px; border-radius: 8px; border: 1px solid #374151; background: #0b1220; color: var(--text); cursor: pointer; }
    .btn-primary { background: var(--accent); border-color: var(--accent); }
    .btn-danger { background: var(--red); border-color: var(--red); }
    .btn-success { background: var(--green); border-color: var(--green); }
    .title { font-size: 22px; font-weight: 600; margin: 0 0 12px; }
    .subtitle { font-size: 14px; color: var(--muted); margin: 0 0 16px; }
    .stat { display: flex; flex-direction: column; gap: 4px; }
    .stat .label { font-size: 12px; color: var(--muted); }
    .stat .value { font-size: 18px; font-weight: 600; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid #1f2937; text-align: left; }
    th { color: var(--muted); font-weight: 500; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header h1 { font-size: 24px; margin: 0; }
    .tag { font-size: 12px; padding: 4px 8px; border-radius: 999px; border: 1px solid #374151; color: var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Helloaca Admin</h1>
      <div class="row">
        <span id="adminEmailTag" class="tag"></span>
        <button id="logoutBtn" class="btn">Logout</button>
      </div>
    </div>

    <div id="loginSection" class="panel">
      <div class="title">Sign in</div>
      <div class="subtitle">Only the authorized admin can sign in.</div>
      <div class="grid grid-responsive">
        <div>
          <div class="stat">
            <span class="label">Email</span>
            <input id="emailInput" type="email" class="input" placeholder="ozoemenachidile@gmail.com" value="ozoemenachidile@gmail.com">
          </div>
        </div>
        <div>
          <div class="stat">
            <span class="label">Password</span>
            <input id="passwordInput" type="password" class="input" placeholder="Admin password">
          </div>
        </div>
        <div>
          <div class="stat">
            <span class="label">API Base</span>
            <input id="apiBaseInput" type="text" class="input" placeholder="https://admin.helloaca.xyz">
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:14px;">
        <button id="loginBtn" class="btn btn-primary">Sign in</button>
      </div>
      <div id="loginError" class="subtitle" style="color: var(--red);"></div>
    </div>

    <div id="dashboardSection" class="hidden">
      <div class="grid grid-responsive">
        <div class="panel">
          <div class="title">Revenue</div>
          <div class="grid grid-3">
            <div class="stat"><span class="label">Card (USD)</span><span id="statCard" class="value">0</span></div>
            <div class="stat"><span class="label">Crypto (USD)</span><span id="statCrypto" class="value">0</span></div>
            <div class="stat"><span class="label">Total (USD)</span><span id="statTotal" class="value">0</span></div>
          </div>
          <canvas id="revenueChart" style="margin-top: 16px; height: 220px;"></canvas>
        </div>
        <div class="panel">
          <div class="title">Users & Activity</div>
          <div class="grid grid-3">
            <div class="stat"><span class="label">Users</span><span id="statUsers" class="value">0</span></div>
            <div class="stat"><span class="label">Active Users</span><span id="statActive" class="value">0</span></div>
            <div class="stat"><span class="label">Notifications</span><span id="statNotifs" class="value">0</span></div>
          </div>
          <div class="grid grid-3" style="margin-top:12px;">
            <div class="stat"><span class="label">Reports</span><span id="statReports" class="value">0</span></div>
            <div class="stat"><span class="label">Messages</span><span id="statMessages" class="value">0</span></div>
            <div class="stat"><span class="label">Contact Submissions</span><span id="statContacts" class="value">0</span></div>
          </div>
          <canvas id="txPieChart" style="margin-top: 16px; height: 220px;"></canvas>
        </div>
      </div>

      <div class="panel" style="margin-top:20px;">
        <div class="title">Usage</div>
        <div class="row-wrap" style="margin-bottom:12px;">
          <input id="fromInput" type="date" class="input" style="max-width:200px;">
          <input id="toInput" type="date" class="input" style="max-width:200px;">
          <button id="refreshBtn" class="btn">Refresh</button>
        </div>
        <canvas id="usageLineChart" style="height:280px;"></canvas>
      </div>

      <div class="grid grid-responsive" style="margin-top:20px;">
        <div class="panel">
          <div class="title">Send Notification</div>
          <div class="grid grid-responsive">
            <div class="stat"><span class="label">Title</span><input id="notifTitle" class="input"></div>
            <div class="stat"><span class="label">Body</span><textarea id="notifBody" class="textarea"></textarea></div>
            <div class="stat"><span class="label">Emails (comma)</span><input id="notifEmails" class="input" placeholder="user1@example.com,user2@example.com"></div>
            <div class="stat"><span class="label">Type</span><select id="notifType" class="select"><option value="system">system</option><option value="info">info</option><option value="promo">promo</option></select></div>
            <div class="row"><input id="notifBroadcast" type="checkbox"> <span class="label">Broadcast to all users</span></div>
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="sendNotifBtn" class="btn btn-success">Send Notifications</button>
            <div id="notifResult" class="subtitle"></div>
          </div>
        </div>

        <div class="panel">
          <div class="title">Send Email</div>
          <div class="grid grid-responsive">
            <div class="stat"><span class="label">Subject</span><input id="emailSubject" class="input"></div>
            <div class="stat"><span class="label">HTML</span><textarea id="emailHtml" class="textarea"></textarea></div>
            <div class="stat"><span class="label">Emails (comma)</span><input id="emailList" class="input" placeholder="user1@example.com,user2@example.com"></div>
            <div class="stat"><span class="label">User IDs (comma)</span><input id="emailUserIds" class="input" placeholder="uuid-1,uuid-2"></div>
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="sendEmailBtn" class="btn btn-primary">Send Emails</button>
            <div id="emailResult" class="subtitle"></div>
          </div>
        </div>
      </div>

      <div class="grid grid-responsive" style="margin-top:20px;">
        <div class="panel">
          <div class="title">Set Credits</div>
          <div class="grid grid-responsive">
            <div class="stat"><span class="label">Email</span><input id="creditEmail" class="input" placeholder="user@example.com"></div>
            <div class="stat"><span class="label">User ID</span><input id="creditUserId" class="input" placeholder="uuid"></div>
            <div class="stat"><span class="label">Amount</span><input id="creditAmount" type="number" class="input" value="1"></div>
            <div class="stat"><span class="label">Mode</span><select id="creditMode" class="select"><option value="add">add</option><option value="set">set</option></select></div>
          </div>
          <div class="row" style="margin-top:12px;">
            <button id="setCreditBtn" class="btn btn-success">Apply</button>
            <div id="creditResult" class="subtitle"></div>
          </div>
        </div>

        <div class="panel">
          <div class="title">Contact Submissions</div>
          <table>
            <thead>
              <tr>
                <th>Email</th>
                <th>Name</th>
                <th>Message</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="contactsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    let adminToken = ''
    let adminEmail = ''
    let charts = { revenue: null, txPie: null, usageLine: null }

    function computeApiBase() {
      const custom = document.getElementById('apiBaseInput')?.value?.trim()
      if (custom) return custom
      const host = window.location.hostname
      if (host.endsWith('admin.helloaca.xyz') || host.endsWith('helloaca.xyz') || host.endsWith('helloaca.vercel.app')) return 'https://admin.helloaca.xyz'
      return window.location.origin
    }

    function setVisible(el, visible) {
      if (visible) el.classList.remove('hidden'); else el.classList.add('hidden')
    }

    function formatUSD(n) {
      return Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(Number(n || 0))
    }

    async function login() {
      const email = String(document.getElementById('emailInput').value || '').trim().toLowerCase()
      const password = String(document.getElementById('passwordInput').value || '')
      const base = computeApiBase()
      const errEl = document.getElementById('loginError')
      errEl.textContent = ''
      try {
        const bases = [base]
        if (!bases.includes('https://admin.helloaca.xyz')) bases.push('https://admin.helloaca.xyz')
        if (!bases.includes(window.location.origin)) bases.push(window.location.origin)
        let success = false
        for (const b of bases) {
          try {
            const res = await fetch(`${b}/api/app`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ action: 'admin_token', email, password })
            })
            const data = await res.json().catch(() => null)
            if (res.ok && data?.token) {
              adminToken = String(data.token)
              adminEmail = email
              localStorage.setItem('adminToken', adminToken)
              localStorage.setItem('adminEmail', adminEmail)
              document.getElementById('adminEmailTag').textContent = adminEmail
              setVisible(document.getElementById('loginSection'), false)
              setVisible(document.getElementById('dashboardSection'), true)
              success = true
              await loadAll()
              break
            }
          } catch {}
        }
        if (!success) errEl.textContent = 'Network or configuration error'
      } catch {
        errEl.textContent = 'Network error'
      }
    }

    async function fetchMetrics() {
      const base = computeApiBase()
      const from = String(document.getElementById('fromInput').value || '')
      const to = String(document.getElementById('toInput').value || '')
      const url = new URL(`${base}/api/app`)
      url.searchParams.set('action', 'admin_metrics')
      if (from) url.searchParams.set('from', from)
      if (to) url.searchParams.set('to', to)
      const res = await fetch(url.toString(), { headers: { 'X-Admin-Token': adminToken, 'X-Admin-Email': adminEmail } })
      const data = await res.json().catch(() => null)
      if (!res.ok || !data?.totals) return
      document.getElementById('statCard').textContent = formatUSD(data.totals.revenue_card_usd)
      document.getElementById('statCrypto').textContent = formatUSD(data.totals.revenue_crypto_usd)
      document.getElementById('statTotal').textContent = formatUSD(data.totals.revenue_total_usd)
      document.getElementById('statUsers').textContent = String(data.totals.users_total || 0)
      document.getElementById('statActive').textContent = String(data.totals.users_active || 0)
      document.getElementById('statNotifs').textContent = String(data.totals.notifications_total || 0)
      document.getElementById('statReports').textContent = String(data.totals.reports_total || 0)
      document.getElementById('statMessages').textContent = String(data.totals.messages_total || 0)
      document.getElementById('statContacts').textContent = String(data.totals.contacts_total || 0)
      renderRevenueChart(data)
      renderTxPieChart(data)
      renderUsageLineChart(data)
    }

    function renderRevenueChart(data) {
      const ctx = document.getElementById('revenueChart').getContext('2d')
      if (charts.revenue) charts.revenue.destroy()
      charts.revenue = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Card', 'Crypto'],
          datasets: [{ label: 'Revenue (USD)', data: [Number(data.totals.revenue_card_usd || 0), Number(data.totals.revenue_crypto_usd || 0)], backgroundColor: ['#4f46e5', '#22c55e'] }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      })
    }

    function renderTxPieChart(data) {
      const ctx = document.getElementById('txPieChart').getContext('2d')
      if (charts.txPie) charts.txPie.destroy()
      charts.txPie = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Card', 'Crypto'],
          datasets: [{ data: [Number(data.totals.transactions_card_count || 0), Number(data.totals.transactions_crypto_count || 0)], backgroundColor: ['#4f46e5', '#22c55e'] }]
        },
        options: { responsive: true }
      })
    }

    function renderUsageLineChart(data) {
      const ctx = document.getElementById('usageLineChart').getContext('2d')
      if (charts.usageLine) charts.usageLine.destroy()
      const daily = Array.isArray(data?.usage?.daily) ? data.usage.daily : []
      charts.usageLine = new Chart(ctx, {
        type: 'line',
        data: {
          labels: daily.map(d => d.date),
          datasets: [
            { label: 'Reports', data: daily.map(d => Number(d.reports || 0)), borderColor: '#4f46e5', backgroundColor: '#4f46e5' },
            { label: 'Messages', data: daily.map(d => Number(d.messages || 0)), borderColor: '#22c55e', backgroundColor: '#22c55e' }
          ]
        },
        options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
      })
    }

    async function sendNotification() {
      const base = computeApiBase()
      const title = String(document.getElementById('notifTitle').value || '')
      const body = String(document.getElementById('notifBody').value || '')
      const emailsValue = String(document.getElementById('notifEmails').value || '')
      const broadcast = document.getElementById('notifBroadcast').checked
      const type = String(document.getElementById('notifType').value || 'system')
      const emails = emailsValue ? emailsValue.split(',').map(s => s.trim()).filter(Boolean) : []
      const res = await fetch(`${base}/api/app`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken, 'X-Admin-Email': adminEmail },
        body: JSON.stringify({ action: 'admin_notify', title, body, type, emails, broadcast })
      })
      const data = await res.json().catch(() => null)
      document.getElementById('notifResult').textContent = res.ok ? `Sent: ${String(data?.sent || 0)}` : String(data?.error || 'Failed')
      await fetchMetrics()
    }

    async function sendEmails() {
      const base = computeApiBase()
      const subject = String(document.getElementById('emailSubject').value || '')
      const html = String(document.getElementById('emailHtml').value || '')
      const emailsValue = String(document.getElementById('emailList').value || '')
      const userIdsValue = String(document.getElementById('emailUserIds').value || '')
      const emails = emailsValue ? emailsValue.split(',').map(s => s.trim()).filter(Boolean) : []
      const userIds = userIdsValue ? userIdsValue.split(',').map(s => s.trim()).filter(Boolean) : []
      const res = await fetch(`${base}/api/app`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken, 'X-Admin-Email': adminEmail },
        body: JSON.stringify({ action: 'admin_email', subject, html, emails, userIds })
      })
      const data = await res.json().catch(() => null)
      document.getElementById('emailResult').textContent = res.ok ? `Sent: ${String(data?.sent || 0)}/${String(data?.requested || 0)}` : String(data?.error || 'Failed')
    }

    async function setCredits() {
      const base = computeApiBase()
      const email = String(document.getElementById('creditEmail').value || '')
      const userId = String(document.getElementById('creditUserId').value || '')
      const amount = Number(document.getElementById('creditAmount').value || 0)
      const mode = String(document.getElementById('creditMode').value || 'add')
      const res = await fetch(`${base}/api/app`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-Admin-Token': adminToken, 'X-Admin-Email': adminEmail },
        body: JSON.stringify({ action: 'admin_set_credits', email: email || undefined, userId: userId || undefined, amount, mode })
      })
      const data = await res.json().catch(() => null)
      document.getElementById('creditResult').textContent = res.ok ? `New balance userId=${String(data?.userId || '')}: ${String(data?.new_balance || '')}` : String(data?.error || 'Failed')
    }

    async function loadContacts() {
      const base = computeApiBase()
      const res = await fetch(`${base}/api/app?action=admin_contacts`, { headers: { 'X-Admin-Token': adminToken, 'X-Admin-Email': adminEmail } })
      const data = await res.json().catch(() => null)
      if (!res.ok || !Array.isArray(data?.contacts)) return
      const tbody = document.getElementById('contactsTableBody')
      tbody.innerHTML = ''
      for (const c of data.contacts) {
        const tr = document.createElement('tr')
        const td1 = document.createElement('td'); td1.textContent = String(c.email || '')
        const td2 = document.createElement('td'); td2.textContent = String(c.name || '')
        const td3 = document.createElement('td'); td3.textContent = String(c.message || '').slice(0, 160)
        const td4 = document.createElement('td'); td4.textContent = new Date(String(c.created_at || '')).toLocaleString()
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4)
        tbody.appendChild(tr)
      }
    }

    async function loadAll() {
      await fetchMetrics()
      await loadContacts()
    }

    function logout() {
      localStorage.removeItem('adminToken')
      localStorage.removeItem('adminEmail')
      adminToken = ''
      adminEmail = ''
      setVisible(document.getElementById('dashboardSection'), false)
      setVisible(document.getElementById('loginSection'), true)
      document.getElementById('adminEmailTag').textContent = ''
    }

    document.getElementById('loginBtn').addEventListener('click', login)
    document.getElementById('logoutBtn').addEventListener('click', logout)
    document.getElementById('refreshBtn').addEventListener('click', fetchMetrics)
    document.getElementById('sendNotifBtn').addEventListener('click', sendNotification)
    document.getElementById('sendEmailBtn').addEventListener('click', sendEmails)
    document.getElementById('setCreditBtn').addEventListener('click', setCredits)

    ;(function init() {
      const tok = localStorage.getItem('adminToken')
      const email = localStorage.getItem('adminEmail')
      if (tok && email) {
        adminToken = tok
        adminEmail = email
        document.getElementById('adminEmailTag').textContent = adminEmail
        setVisible(document.getElementById('loginSection'), false)
        setVisible(document.getElementById('dashboardSection'), true)
        loadAll()
      } else {
        setVisible(document.getElementById('loginSection'), true)
        setVisible(document.getElementById('dashboardSection'), false)
      }
      const now = new Date()
      const past = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000)
      document.getElementById('fromInput').value = past.toISOString().slice(0,10)
      document.getElementById('toInput').value = now.toISOString().slice(0,10)
    })()
  </script>
</body>
</html>
